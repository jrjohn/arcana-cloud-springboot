###############################################################################
# Kubernetes Network Policies for Arcana Cloud gRPC Communication
#
# These policies enforce security boundaries between service layers:
# - Controller Layer: Accepts external traffic, connects to Service via gRPC
# - Service Layer: Only accepts traffic from Controller, connects to Repository
# - Repository Layer: Only accepts traffic from Service Layer
###############################################################################

---
# Namespace-level default: Deny all traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: arcana-cloud
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Controller Layer Network Policy
# Allows:
# - Ingress: HTTP traffic from Ingress controller
# - Egress: gRPC to Service Layer, DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: controller-network-policy
  namespace: arcana-cloud
  labels:
    layer: controller
spec:
  podSelector:
    matchLabels:
      app: arcana-controller
      layer: controller
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow HTTP traffic from Ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  # Allow health checks from K8s control plane
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8  # Adjust for your cluster CIDR
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow gRPC to Service Layer
  - to:
    - podSelector:
        matchLabels:
          app: arcana-service
          layer: service
    ports:
    - protocol: TCP
      port: 9090
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Service Layer Network Policy
# Allows:
# - Ingress: gRPC from Controller Layer, HTTP for health checks
# - Egress: gRPC to Repository Layer, Redis, DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: service-network-policy
  namespace: arcana-cloud
  labels:
    layer: service
spec:
  podSelector:
    matchLabels:
      app: arcana-service
      layer: service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow gRPC from Controller Layer
  - from:
    - podSelector:
        matchLabels:
          app: arcana-controller
          layer: controller
    ports:
    - protocol: TCP
      port: 9090
  # Allow health checks from K8s control plane
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8  # Adjust for your cluster CIDR
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 8081
  # Allow inter-pod communication (for plugin sync)
  - from:
    - podSelector:
        matchLabels:
          app: arcana-service
          layer: service
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # Allow gRPC to Repository Layer
  - to:
    - podSelector:
        matchLabels:
          app: arcana-repository
          layer: repository
    ports:
    - protocol: TCP
      port: 9091
  # Allow Redis connection (for distributed plugin registry)
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow MySQL connection
  - to:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Repository Layer Network Policy
# Allows:
# - Ingress: gRPC from Service Layer only
# - Egress: MySQL, Redis, DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: repository-network-policy
  namespace: arcana-cloud
  labels:
    layer: repository
spec:
  podSelector:
    matchLabels:
      app: arcana-repository
      layer: repository
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow gRPC from Service Layer only
  - from:
    - podSelector:
        matchLabels:
          app: arcana-service
          layer: service
    ports:
    - protocol: TCP
      port: 9091
  # Allow health checks from K8s control plane
  - from:
    - ipBlock:
        cidr: 10.0.0.0/8  # Adjust for your cluster CIDR
    ports:
    - protocol: TCP
      port: 9091
  egress:
  # Allow MySQL connection
  - to:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
  # Allow Redis connection
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Redis Network Policy
# Only accepts connections from Service and Repository layers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-network-policy
  namespace: arcana-cloud
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          layer: service
    - podSelector:
        matchLabels:
          layer: repository
    ports:
    - protocol: TCP
      port: 6379

---
# MySQL Network Policy
# Only accepts connections from Service and Repository layers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-network-policy
  namespace: arcana-cloud
spec:
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          layer: service
    - podSelector:
        matchLabels:
          layer: repository
    ports:
    - protocol: TCP
      port: 3306
