<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.arcana.cloud.dao.impl.mybatis.mapper.OAuthTokenMapper">

    <!-- Result Map -->
    <resultMap id="OAuthTokenResultMap" type="com.arcana.cloud.entity.OAuthToken">
        <id property="id" column="id"/>
        <result property="accessToken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="tokenType" column="token_type"/>
        <result property="expiresAt" column="expires_at"/>
        <result property="refreshExpiresAt" column="refresh_expires_at"/>
        <result property="isRevoked" column="is_revoked"/>
        <result property="createdAt" column="created_at"/>
        <result property="clientIp" column="client_ip"/>
        <result property="userAgent" column="user_agent"/>
        <association property="user" column="user_id" javaType="com.arcana.cloud.entity.User">
            <id property="id" column="user_id"/>
        </association>
    </resultMap>

    <!-- Result Map with full User -->
    <resultMap id="OAuthTokenWithUserResultMap" type="com.arcana.cloud.entity.OAuthToken">
        <id property="id" column="id"/>
        <result property="accessToken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="tokenType" column="token_type"/>
        <result property="expiresAt" column="expires_at"/>
        <result property="refreshExpiresAt" column="refresh_expires_at"/>
        <result property="isRevoked" column="is_revoked"/>
        <result property="createdAt" column="created_at"/>
        <result property="clientIp" column="client_ip"/>
        <result property="userAgent" column="user_agent"/>
        <association property="user" javaType="com.arcana.cloud.entity.User">
            <id property="id" column="user_id"/>
            <result property="username" column="user_username"/>
            <result property="email" column="user_email"/>
            <result property="role" column="user_role"/>
        </association>
    </resultMap>

    <!-- Insert -->
    <insert id="insert" parameterType="com.arcana.cloud.entity.OAuthToken" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO oauth_tokens (user_id, access_token, refresh_token, token_type, expires_at, refresh_expires_at,
                                  is_revoked, created_at, client_ip, user_agent)
        VALUES (#{user.id}, #{accessToken}, #{refreshToken}, #{tokenType}, #{expiresAt}, #{refreshExpiresAt},
                #{isRevoked}, COALESCE(#{createdAt}, NOW()), #{clientIp}, #{userAgent})
    </insert>

    <!-- Update -->
    <update id="update" parameterType="com.arcana.cloud.entity.OAuthToken">
        UPDATE oauth_tokens
        SET access_token = #{accessToken},
            refresh_token = #{refreshToken},
            token_type = #{tokenType},
            expires_at = #{expiresAt},
            refresh_expires_at = #{refreshExpiresAt},
            is_revoked = #{isRevoked},
            client_ip = #{clientIp},
            user_agent = #{userAgent}
        WHERE id = #{id}
    </update>

    <!-- Find by ID -->
    <select id="findById" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens WHERE id = #{id}
    </select>

    <!-- Find by Access Token -->
    <select id="findByAccessToken" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens WHERE access_token = #{accessToken}
    </select>

    <!-- Find by Refresh Token -->
    <select id="findByRefreshToken" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens WHERE refresh_token = #{refreshToken}
    </select>

    <!-- Find by User ID and Not Revoked -->
    <select id="findByUserIdAndIsRevokedFalse" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens WHERE user_id = #{userId} AND is_revoked = false
    </select>

    <!-- Find Valid Tokens by User ID -->
    <select id="findValidTokensByUserId" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens
        WHERE user_id = #{userId} AND is_revoked = false AND expires_at > #{now}
    </select>

    <!-- Exists by ID -->
    <select id="existsById" resultType="boolean">
        SELECT COUNT(*) > 0 FROM oauth_tokens WHERE id = #{id}
    </select>

    <!-- Find All -->
    <select id="findAll" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens ORDER BY created_at DESC
    </select>

    <!-- Find All with Pagination -->
    <select id="findAllWithPagination" resultMap="OAuthTokenResultMap">
        SELECT * FROM oauth_tokens ORDER BY created_at DESC LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count -->
    <select id="count" resultType="long">
        SELECT COUNT(*) FROM oauth_tokens
    </select>

    <!-- Revoke All Tokens by User ID -->
    <update id="revokeAllTokensByUserId">
        UPDATE oauth_tokens SET is_revoked = true WHERE user_id = #{userId}
    </update>

    <!-- Revoke by Access Token -->
    <update id="revokeByAccessToken">
        UPDATE oauth_tokens SET is_revoked = true WHERE access_token = #{accessToken}
    </update>

    <!-- Delete Expired or Revoked Tokens -->
    <delete id="deleteExpiredOrRevokedTokens">
        DELETE FROM oauth_tokens WHERE expires_at &lt; #{now} OR is_revoked = true
    </delete>

    <!-- Delete by ID -->
    <delete id="deleteById">
        DELETE FROM oauth_tokens WHERE id = #{id}
    </delete>

    <!-- Delete All -->
    <delete id="deleteAll">
        DELETE FROM oauth_tokens
    </delete>

</mapper>
